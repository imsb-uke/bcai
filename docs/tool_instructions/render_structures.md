# `render_structures(files, …)`

## Purpose

Render one or more structures (PDB/CIF/SDF/MOL2) with fine-grained control over **models**, **chains**, **residues**, **elements**, and **HETATM**.

**Note:**
If no style was requested, set the input to the following setting:
- Proteins (PDB/CIF): cartoon, opacity: 1.0
- Surface: on, type = VDW, opacity 0.6 colored by b-factor
- Non-protein atoms (HETATM) inside PDB/CIF: stick, radius:0.1
- External ligands (SDF/MOL2): stick, radius:0.1 (For ligands, by defult use SDF and not PDB)
- Multiple ligands: each ligand gets a distinct color; a legend is added listing ligand IDs/colors.
- If `interaction_tables` is given, use ball-and-stick to show the ligand (by defult, sphere radius : 0.4 and stick radius : 0.15). Also, do not show any surface by defult.
“Ball-and-stick” = sphere + stick styles applied together.

If the user asks to show the interactions, you need to use "interaction_table" csv file generated by `get_protein_ligand_interaction` tool. To plot the interactions, you can either use `render_structures()` or `interaction_plot()` if they need a simple plot.

The above setting are not done automatically, you should set the input accordingly. See below.

## Key Arguments

* `files: List[str]` **pdb or sdf files.** if interaction table is provided, the corresponding complex pdb file should be used.
  Paths; order defines model indices `0..N-1`.
* `style_rules: List[{select, style}]` *(optional)*
  Apply styles to selections. **Later rules override earlier ones** on overlapping atoms.
* `surface_rules: List[{select, surface, type}]` *(optional)*
  Add surfaces by selection. `type ∈ {py3Dmol.VDW, py3Dmol.MS, py3Dmol.SAS}`.
* `label_rules: List[{text, position|select, style}]` *(optional)*
* `chain_color_map: Dict[int|"all", Dict[chainId, color]]` *(optional)*
  Per-chain cartoon colors. Use `"all"` for a fallback; **apply general first, then specific**.
* `interaction_tables: Optional[List[Optional[str]]] = None`, *(optional)* **interaction table csv dirs**.
* `interaction_color: str = "purple",`
* `interaction_types: Optional[List[str]] = None,` *(optional)* **to specify interaction types to show, None=all**.
* `box_constraint: str | None = None` *(optional)* **box constraint file**.
* `box_color: str` (default `"blue"`)
* `box_opacity: float` (default `0.3`)
* `background: str` (default `"white"`)
* `size: (int,int)` (default `(1000, 800)`)
* `zoom: bool` (default `True`)
* `out_html: str|None` (save target; returns HTML string always)

## Selection Schema (`select`)

```json
{
  "model": 0,                 // int or [int,...]
  "chain": "A",               // str
  "resi": [10,11,120],        // int|[...]
  "resn": ["BH4","WAT"],      // residue names
  "elem": "O",                // element
  "hetflag": true,            // HETATM (ligands/ions)
  "invert": true              // invert the selection
}
```

## Style Schema (`style`)

Combine any:

```json
{
  "cartoon": {"color": "#rrggbb", "opacity": 0.9},
  "stick":   {"radius": 0.25, "colorscheme": "cyanCarbon"},
  "sphere":  {"radius": 1.0,  "colorscheme": "whiteCarbon"},
  "line":    {},
  "cross":   {}
}
```

## Surface Rules

```json
{
  "select": {"model": 0, "chain": "A", "hetflag": false},
  "surface": {"opacity": 0.4},         // you can also add "color": "#aaaaaa"
  "type": "py3Dmol.MS"                 // VDW | MS | SAS (use the constants in code)
}
```

Notes:

* **VDW**: fast, atom-radius based.
* **MS**: solvent-excluded (molecular) surface.
* **SAS**: solvent-accessible surface.


### Coloring by Prob, e.g. B-factor (temperature factor), etc.

Use a **property-mapped colorscheme** on any style (cartoon/stick/sphere):

```json
{
  "cartoon": {
    "opacity": 0.9,
    "colorscheme": { "prop": "b", "gradient": "rwb", "min": 0, "max": 100, "mid": 50}
  }
}
```
and surface
```json
{
    "surface":{
        "opacity":0.9, 
        "map": { "prop": "b", "scheme": {"gradient": "rwb", "min": 0, "max": 100, "mid": 50 } }
    }
}
```

* `prop: "b"` targets B-factor; `prop: "q"` Occupancy; `prop: "partialCharge"` Partial atomic charge; `prop: "vdw"` van der Waals radius
* `gradient`: common ramps: `"rwb"`, `"roygb"`, `"sinebow"`.
* For b-factor, always use "min": 0, "max": 100

## Legend (multi-ligand)

* When multiple distinct ligands are present (different **external ligand models** or **HETATM resnames**), the function assigns **distinct colors** and adds a **legend** (e.g., filename or `resn` labels with swatches).
* You can still override ligand colors with `style_rules` (later rules win).

---

## Minimal Usage

```json
{
  "files": ["files/6N1K.pdb", "files/ligand1.sdf", "files/ligand2.sdf"],
  "file_name": "scene"
}
```

## Per-chain Coloring (helper map)

```json
{
  "files": ["files/6N1K.pdb"],
  "chain_color_map": {
    "all": {"_": "#cccccc"},
      "0": { "A": "#1f77b4", "B": "#ff0000", "C": "#2ca02c", "D": "#9467bd" }
  },
  "file_name": "scene"
}
```

> Apply `"all"` first, then model-specific entries so specifics override fallback.

## Explicit Styling (full control)

```json
{
  "files": ["files/6N1K.pdb", "files/BH4_pose.sdf"],
  "style_rules": [
    {
      "select": { "model": 0, "hetflag": false, "chain": "A" },
      "style":  { "cartoon": { "color": "#1f77b4", "opacity": 1.0 } }
    },
    {
      "select": { "model": 0, "hetflag": false, "chain": "B" },
      "style":  { "line": {} }
    },
    {
      "select": { "model": 0, "chain": "A", "resi": [123, 197, 222] },
      "style":  { "stick": { "radius": 0.4 } }
    },
    {
      "select": { "model": 0, "hetflag": true, "resn": ["HOH", "WAT"], "chain": "B" },
      "style":  { "sphere": { "radius": 0.9, "colorscheme": "whiteCarbon" } }
    },
    {
      "select": { "model": 1 },   // external ligand
      "style":  {
        "sphere": { "radius": 1.0 },
        "stick":  { "radius": 0.3, "colorscheme": "cyanCarbon" }
      }
    }
  ],
  "surface_rules": [
    {
      "select":  { "model": 0, "hetflag": false, "chain": "A" },
      "surface": { "opacity": 0.45, "map": { "prop": "b", "scheme": {"gradient": "rwb", "min": 0, "max": 100, "mid": 50 } },
      "type": "VDW"
    },
    {
      "select":  { "model": 0, "hetflag": false, "chain": "B" },
      "surface": { "opacity": 0.25 },
      "type": "VDW"
    }
  ],
  "file_name": "scene"
}
```

## Tips & Pitfalls
* **Rule precedence:** the **last** style touching an atom takes effect.
* **Water visibility:** waters often have only O atoms (no bonds). Use **sphere** (or sphere+stick), not stick alone.
* **Target precisely:** use `hetflag:true` for ligands; `invert:true` with `hetflag:true` means “protein only”.
* **Consistent legends:** if you override ligand colors, do it **after** defaults so the legend reflects your colors.
* **Prefare `style_rules`** and you use `style_rules`, you don't use `chain_color_map` anymore.